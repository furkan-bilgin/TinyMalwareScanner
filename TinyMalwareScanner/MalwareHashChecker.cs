using System.Text.Json;
using System.Text.Json.Serialization;

namespace TinyMalwareScanner
{
    public class MalwareHashChecker
    {
        public class DOHResult
        {
            public class DOHAnswer
            {
                [JsonPropertyName("data")]
                public string? Data { get; set; }
            }

            public List<DOHAnswer>? Answer { get; set; }
        }

        private HttpClient httpClient = new();

        public MalwareHashChecker()
        {
            httpClient.DefaultRequestHeaders.Add("Accept", "application/dns-json");
        }

        public async Task<int> Check(string md5)
        {
            var dnsUrl = $"{md5}.hash.cymru.com";
            var dohUrl = $"https://cloudflare-dns.com/dns-query?name={dnsUrl}&type=TXT";
            var query = await httpClient.GetStringAsync(dohUrl);

            var result = JsonSerializer.Deserialize<DOHResult>(query);
            if (result == null || result.Answer == null || result.Answer.Count == 0)
            {
                return 0;
            }

            var resultSplit = result.Answer.First().Data.Replace("\"", "").Split(" ");

            (var unix, var avHit) = (resultSplit[0], resultSplit[1]);
            return int.Parse(avHit);
        }
    }
}
