using System.Diagnostics;

namespace TinyMalwareScanner
{
    public class MalwareScanner
    {
        const string QUARANTINE_EXTENSION = ".quarantine";

        private MalwareHashChecker malwareHashChecker = new();
        private ProcessMonitor processMonitor = new();
        private HashDatabase hashDatabase = new();

        private System.Threading.Timer? saveDatabaseTimer;

        public MalwareScanner()
        {
            Initialize();
        }

        private async void Initialize()
        {
            await hashDatabase.LoadDatabase();

            processMonitor.ProcessStartEvent += ProcessMonitor_ProcessStart;
            processMonitor.StartMonitoring();

            saveDatabaseTimer = new System.Threading.Timer(e => _ = hashDatabase.SaveDatabase(), null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
        }

        private async void ProcessMonitor_ProcessStart(string path, Process process)
        {
            try
            {
                var fileMd5 = hashDatabase.GetHash(path) ?? MD5.CalculateMD5(path);
                var avHit = hashDatabase.GetAvHash(fileMd5) ?? await malwareHashChecker.Check(fileMd5);

                if (avHit > 0)
                {
                    _ = Task.Run(() => VirusAction(path, process));

                    Process.Start("explorer.exe", $"/select, \"{path + QUARANTINE_EXTENSION}\"");
                    MessageBox.Show($"A virus has been detected at path '{path}' with AV Hit Score {avHit}.", "Warning", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1, MessageBoxOptions.DefaultDesktopOnly);
                }

                hashDatabase.SetHash(path, fileMd5);
                hashDatabase.SetAvHash(fileMd5, avHit);
            }
            catch (Exception ex)
            {
                Debug.WriteLine(ex);
            }
        }

        private void VirusAction(string path, Process process)
        {
            while (File.Exists(path))
            {
                try
                {
                    process.Kill();
                    File.Move(path, path + QUARANTINE_EXTENSION);
                }
                catch
                {
                }
            }
        }

        public async Task PrepareExit()
        {
            await hashDatabase.SaveDatabase();
        }
    }
}
