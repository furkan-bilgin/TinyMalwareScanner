using System.Diagnostics;

namespace TinyMalwareScanner
{
    public class MalwareScanner
    {
        private readonly string QUARANTINE_EXTENSION = ".quarantine";
        private readonly TimeSpan QUARANTINE_TIMEOUT = TimeSpan.FromSeconds(60);

        private MalwareHashChecker malwareHashChecker = new();
        private ProcessMonitor processMonitor = new();
        private HashDatabase hashDatabase = new();

        private System.Threading.Timer? saveDatabaseTimer;
        private System.Threading.Timer? checkRunningProcessesTimer;

        public MalwareScanner()
        {
            Initialize();
        }

        private async void Initialize()
        {
            await hashDatabase.LoadDatabase();

            processMonitor.ProcessStartEvent += ProcessMonitor_ProcessStart;
            processMonitor.StartMonitoring();

            saveDatabaseTimer = new System.Threading.Timer(e => _ = hashDatabase.SaveDatabase(), null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
            checkRunningProcessesTimer = new System.Threading.Timer(e => CheckRunningProcesses(), null, TimeSpan.Zero, TimeSpan.FromHours(1));
        }

        private void CheckRunningProcesses()
        {
            var processes = Process.GetProcesses();

            foreach (var process in processes)
            {
                foreach (var path in processMonitor.GetAllPathsOfProcess(process))
                {
                    try
                    {
                        ScanProcess(path, process);
                    }
                    catch { }
                }
            }
        }

        private void ProcessMonitor_ProcessStart(string path, Process process)
        {
            ScanProcess(path, process);
        }

        private async void ScanProcess(string path, Process process)
        {
            try
            {
                var fileMd5 = hashDatabase.GetHash(path) ?? MD5.CalculateMD5(path);
                var avHit = hashDatabase.GetAvHash(fileMd5) ?? await malwareHashChecker.Check(fileMd5);

                if (avHit > 0)
                {
                    _ = Task.Run(() => QuarantineProcess(path, process));
                    MessageBox.Show($"A virus has been detected at path '{path}' with AV Hit Score {avHit}.", "Warning", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1, MessageBoxOptions.DefaultDesktopOnly);
                }

                hashDatabase.SetHash(path, fileMd5);
                hashDatabase.SetAvHash(fileMd5, avHit);
            }
            catch (Exception ex)
            {
                Debug.WriteLine(ex);
            }
        }

        private HashSet<string> quarantineProcessSet = new();
        private void QuarantineProcess(string path, Process process)
        {
            lock (quarantineProcessSet)
            {
                if (quarantineProcessSet.Contains(path))
                {
                    return;
                }

                quarantineProcessSet.Add(path);
            }

            var quarantineStartDate = DateTime.Now;
            var newPath = path + QUARANTINE_EXTENSION;
            while (File.Exists(path))
            {
                if (DateTime.Now - quarantineStartDate > QUARANTINE_TIMEOUT)
                {
                    break;
                }

                try
                {
                    process.Kill();

                    try
                    {
                        foreach (var item in FileUtil.WhoIsLocking(path))
                        {
                            item.Kill();
                        }
                    }
                    catch { }

                    File.Move(path, newPath);
                }
                catch (Exception ex)
                {
                    Debug.WriteLine(ex.ToString());
                }
            }

            Process.Start("explorer.exe", $"/select, \"{newPath}\"");
        }

        public async Task PrepareExit()
        {
            await hashDatabase.SaveDatabase();
        }
    }
}
