using System.Text.Json;

namespace TinyMalwareScanner
{
    public class HashDatabase
    {
        const string DB_PATH = "./db.json";
        public HashDatabaseDB db;

        public async Task LoadDatabase()
        {
            if (!File.Exists(DB_PATH))
            {
                File.Create(DB_PATH).Close();
                db = new();
                await SaveDatabase();

                return;
            }

            using var file = File.OpenRead(DB_PATH);
            db = await JsonSerializer.DeserializeAsync<HashDatabaseDB>(file) ?? new HashDatabaseDB();
        }

        public async Task SaveDatabase()
        {
            using var file = File.OpenWrite(DB_PATH);
            await JsonSerializer.SerializeAsync<HashDatabaseDB>(file, db);
        }

        public void SetHash(string path, string hash)
        {
            db.Hashes[path] = hash;
        }

        public string? GetHash(string path)
        {
            return db.Hashes.ContainsKey(path) ? db.Hashes[path] : null;
        }

        public void SetAvHash(string fileMd5, int avHit)
        {
            db.AvHashes[fileMd5] = avHit;
        }

        public int? GetAvHash(string fileMd5)
        {
            return db.AvHashes.ContainsKey(fileMd5) ? db.AvHashes[fileMd5] : null;
        }
    }
}
